<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RDV Image Generator</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- CSS for canvas background image display -->
    <style>
      /* Ensure canvas background images display properly */
      #canvas {
        min-height: 600px !important;
        width: 100% !important;
        display: block !important;
        position: relative !important;
        background-color: transparent !important;
      }

      #canvas.image-loaded {
        animation: imageLoaded 0.3s ease-in-out;
      }

      @keyframes imageLoaded {
        0% {
          opacity: 0.8;
        }
        100% {
          opacity: 1;
        }
      }

      #canvas.refreshing {
        transform: translateZ(0);
      }

      /* Hide placeholder content when image is loaded */
      #canvas:not(:empty) .placeholder-content {
        display: none !important;
      }

      /* Ensure canvas wrapper doesn't interfere */
      .canvas-wrapper {
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: transparent;
      }

      .preview-container {
        width: 100%;
        height: 100%;
        background: transparent;
      }

      /* Force background image visibility */
      #canvas[data-bg-loaded='true'] {
        background-attachment: scroll !important;
        background-origin: padding-box !important;
        background-clip: border-box !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header class="header">
        <div class="header-content">
          <div class="logo">
            <img src="assets/rdv-logo.png" alt="RDV" />
            <h1>Image Generator</h1>
          </div>
          <div class="header-actions">
            <button id="testAirtableBtn" class="btn-secondary">
              Test Airtable
            </button>
            <button id="downloadBtn" class="btn-primary">Descargar</button>
            <button id="uploadToAirtableBtn" class="btn-primary">
              Guardar en Airtable
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Sidebar -->
        <aside class="sidebar">
          <div class="form-section">
            <h2>Configuración</h2>

            <!-- Airtable Integration -->
            <div class="input-group">
              <label for="recordId">ID de Registro (Airtable)</label>
              <input
                type="text"
                id="recordId"
                placeholder="rec..."
                class="input-field"
              />
              <button id="loadFromAirtableBtn" class="btn-secondary">
                Cargar desde Airtable
              </button>
            </div>

            <!-- Title -->
            <div class="input-group">
              <label for="title">Título</label>
              <textarea
                id="title"
                placeholder="Título de la noticia"
                class="input-field"
                rows="2"
                maxlength="120"
              ></textarea>
              <div class="char-counter">
                <span id="titleCounter">0</span>/120
              </div>
            </div>

            <!-- Excerpt -->
            <div class="input-group">
              <label for="excerpt">Extracto</label>
              <textarea
                id="excerpt"
                placeholder="Resumen breve de la noticia"
                class="input-field"
                rows="3"
                maxlength="200"
              ></textarea>
              <div class="char-counter">
                <span id="excerptCounter">0</span>/200
              </div>
            </div>

            <!-- Tags -->
            <div class="input-group">
              <label for="tags">Tags</label>
              <input
                type="text"
                id="tags"
                placeholder="economia, politica, sociedad"
                class="input-field"
              />
            </div>

            <!-- Category -->
            <div class="input-group">
              <label for="category">Categoría</label>
              <select id="category" class="input-field">
                <option value="general">General</option>
                <option value="economia">Economía</option>
                <option value="politica">Política</option>
                <option value="sociedad">Sociedad</option>
                <option value="deportes">Deportes</option>
                <option value="tecnologia">Tecnología</option>
                <option value="cultura">Cultura</option>
              </select>
            </div>

            <!-- Background Image -->
            <div class="input-group">
              <label for="backgroundImage">Imagen de Fondo</label>
              <input
                type="url"
                id="backgroundImage"
                placeholder="https://ejemplo.com/imagen.jpg"
                class="input-field"
              />
              <input
                type="file"
                id="backgroundImageFile"
                accept="image/*"
                class="file-input"
              />
            </div>

            <!-- Source -->
            <div class="input-group">
              <label for="source">Fuente</label>
              <input
                type="text"
                id="source"
                value="RDV Noticias"
                class="input-field"
              />
            </div>

            <!-- Author -->
            <div class="input-group">
              <label for="author">Autor</label>
              <input
                type="text"
                id="author"
                value="Redacción RDV"
                class="input-field"
              />
            </div>

            <!-- Template Selection -->
            <div class="input-group">
              <label for="template">Template</label>
              <select id="template" class="input-field">
                <option value="default">Predeterminado</option>
                <option value="minimal">Minimalista</option>
                <option value="bold">Llamativo</option>
                <option value="elegant">Elegante</option>
              </select>
            </div>

            <!-- Color Theme -->
            <div class="input-group">
              <label for="colorTheme">Tema de Color</label>
              <select id="colorTheme" class="input-field">
                <option value="red">Rojo RDV</option>
                <option value="blue">Azul</option>
                <option value="green">Verde</option>
                <option value="purple">Morado</option>
                <option value="orange">Naranja</option>
              </select>
            </div>
          </div>
        </aside>

        <!-- Preview Area -->
        <section class="preview-area">
          <div class="preview-container">
            <div class="canvas-wrapper">
              <div id="canvas" class="canvas">
                <!-- Dynamic content will be inserted here -->
                <div class="placeholder-content">
                  <div class="template-overlay">
                    <div class="content-area">
                      <div class="header-section">
                        <div class="logo-area">
                          <img
                            src="assets/rdv-logo.png"
                            alt="RDV"
                            class="logo-img"
                          />
                        </div>
                        <div class="category-badge" id="categoryBadge">
                          GENERAL
                        </div>
                      </div>

                      <div class="main-content-area">
                        <h1 class="title-text" id="titleText">
                          Título de la noticia aparecerá aquí
                        </h1>
                        <p class="excerpt-text" id="excerptText">
                          El extracto de la noticia se mostrará en este espacio
                        </p>
                      </div>

                      <div class="footer-section">
                        <div class="source-info">
                          <span class="source-text" id="sourceText"
                            >RDV Noticias</span
                          >
                          <span class="author-text" id="authorText"
                            >Redacción RDV</span
                          >
                        </div>
                        <div class="tags-area" id="tagsArea"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-indicator">
      <div class="loading-spinner"></div>
      <p>Procesando...</p>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="js/core/dom-utils.js"></script>
    <script src="js/core/template-engine.js"></script>
    <script src="js/core/image-capture.js"></script>
    <script src="js/integrations/airtable-integration.js"></script>
    <script src="js/main.js"></script>

    <script>
      // Get record ID from URL parameters
      const urlParams = new URLSearchParams(window.location.search)
      const recordId = urlParams.get('recordId') || urlParams.get('id')

      if (recordId) {
        document.getElementById('recordId').value = recordId
      }

      document.addEventListener('DOMContentLoaded', function () {
        if (recordId) {
          window.addEventListener('load', () => {
            setTimeout(() => {
              loadFromAirtable(recordId)
            }, 1500)
          })
        }
      })

      function addBackToAirtableButton() {
        const header = document.querySelector('.header-actions')
        if (header) {
          const backButton = document.createElement('button')
          backButton.className = 'btn-secondary'
          backButton.innerHTML = '← Back to Airtable'
          backButton.onclick = () => window.close()
          header.prepend(backButton)
        }
      }

      // Add debugging functions to window for console access
      window.debugCanvasVisibility = function () {
        const canvas = document.getElementById('canvas')
        if (canvas) {
          const computedStyles = window.getComputedStyle(canvas)
          console.log('Canvas visibility debug:', {
            display: computedStyles.display,
            visibility: computedStyles.visibility,
            opacity: computedStyles.opacity,
            width: computedStyles.width,
            height: computedStyles.height,
            backgroundImage: computedStyles.backgroundImage,
            position: computedStyles.position,
            zIndex: computedStyles.zIndex,
            overflow: computedStyles.overflow,
          })

          const rect = canvas.getBoundingClientRect()
          console.log('Canvas position:', {
            top: rect.top,
            left: rect.left,
            width: rect.width,
            height: rect.height,
            visible: rect.width > 0 && rect.height > 0,
          })
        }
      }

      window.forceCanvasRefresh = function () {
        const canvas = document.getElementById('canvas')
        if (canvas) {
          canvas.style.transform = 'translateZ(0)'
          canvas.offsetHeight
          canvas.style.transform = ''

          canvas.classList.add('refreshing')
          setTimeout(() => {
            canvas.classList.remove('refreshing')
          }, 100)
        }
      }

      // Auto-add back button if opened from Airtable
      if (recordId) {
        setTimeout(addBackToAirtableButton, 1000)
      }
    </script>
  </body>
</html>
